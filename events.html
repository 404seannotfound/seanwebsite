<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Schedule Helper</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 300px;
            height: 100vh;
            overflow: hidden;
            background: #f4f4f4;
            padding: 0;
            border-right: 1px solid #ccc;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .view-toggle {
            padding: 10px;
            background: #f4f4f4;
            border-bottom: 1px solid #ccc;
            display: flex;
            gap: 10px;
            z-index: 1;
            position: relative;
        }
        .toggle-btn {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid #4CAF50;
            background: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .toggle-btn.active {
            background: #4CAF50;
            color: white;
        }
        .map-view {
            flex: 1;
            position: relative;
        }
        #map {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .calendar-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            display: none;
        }
        .month-divider {
            grid-column: 1 / -1;
            background: #4CAF50;
            color: white;
            padding: 8px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #ccc;
        }
        .event-item:hover {
            background: #ddd;
        }
        .month-nav {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        .month-btn {
            padding: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: white;
        }
        .month-btn.active {
            background: #4CAF50;
            color: white;
        }
        .event-item.highlighted {
            background: #e8f5e9;
        }
        .event-item.highlighted:hover {
            background: #c8e6c9;
        }
        .event-item.selected {
            background: #4CAF50;
            color: white;
        }
        .event-item.selected:hover {
            background: #45a049;
        }
        .time-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .collapse-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .collapse-btn:hover {
            background: #45a049;
        }
        .timeline-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        .timeline-content.collapsed {
            max-height: 0;
        }
        .month-header {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 10px;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .event-details {
            font-size: 12px;
            color: #666;
        }
        .event-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .event-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .travel-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            font-size: 0.9em;
            color: #666;
        }
        .trip-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #4CAF50;
            font-weight: bold;
        }
        .trip-summary h4 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .calendar-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 15px;
            background: #ddd;
            padding: 2px;
            border-radius: 5px;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 2px;
        }
        
        .calendar-day {
            background: white;
            padding: 5px;
            min-height: 80px;
            font-size: 0.8em;
        }
        
        .calendar-day-header {
            background: #4CAF50;
            color: white;
            padding: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .calendar-day.empty {
            background: #f5f5f5;
        }
        
        .calendar-event {
            background: #e8f5e9;
            margin: 2px 0;
            padding: 3px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .calendar-event:hover {
            background: #c8e6c9;
        }
        
        .calendar-event.selected {
            background: #4CAF50;
            color: white;
        }
        
        .calendar-event.selected:hover {
            background: #45a049;
        }
        .calendar-day.today {
            background: #fff3e0;  /* Light orange background */
            border: 2px solid #ff9800;  /* Orange border */
            box-sizing: border-box;
            font-weight: bold;
        }
        .event-item.past {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .calendar-view {
            flex: 1;
            overflow-y: auto;
            display: none;
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #45a049;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .zoom-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            display: none; /* Hidden by default */
        }
        .zoom-btn:hover {
            background: #45a049;
        }
        .event-item.past .event-name,
        .event-item.past .event-details {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .event-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .filter-btn {
            background: white;
            color: #4CAF50;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .filter-btn:hover {
            background: #f0f0f0;
        }
        .event-item {
            display: none; /* Hide by default */
        }
        .event-item.show {
            display: flex; /* Show when has 'show' class */
        }
        .bug-report {
            color: red;
            font-size: 12px;
            margin-left: 15px;
        }
        
        .bug-report a {
            color: red;
            text-decoration: underline;
        }
        .event-item.suspect-date {
            background-color: rgba(255, 255, 0, 0.1); /* Light yellow background */
        }
        
        .broken-link {
            color: #999; /* Gray out broken links */
            text-decoration: line-through;
        }
        
        .suspect-link::after {
            content: " ⚠️"; /* Warning emoji after suspect links */
        }
        
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
            display: none;
        }
        
        .loading-indicator.show {
            display: block;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <span>Event Schedule Helper</span>
            <button class="filter-btn" onclick="toggleEventFilter(this)">Show Selected</button>
        </div>
        <div class="event-list"></div>
    </div>
    <div class="main-content">
        <div class="view-toggle">
            <button class="toggle-btn active" data-view="map">Map View</button>
            <button class="toggle-btn" data-view="calendar">Calendar View</button>
            <span class="bug-report">Some of the dates are wrong. Sorry. If you notice one -- <a href="https://forms.gle/Zcmc4o9x434T6SYF8" target="_blank">report it here</a> or <a href="contribute.html" target="_blank">learn how to fix it yourself</a>.</span>
        </div>
        <div id="map"></div>
        <div class="calendar-container">
            <div class="calendar-header"></div>
            <div class="calendar"></div>
        </div>
    </div>
    <div id="timeInfo" class="time-info"></div>
    <div class="loading-indicator">
        <div class="loading-spinner"></div>
        <div>Loading events...</div>
    </div>
    
    <script>
        let events = []; // Will be populated from JSON

        document.addEventListener("DOMContentLoaded", function () {
            // Show loading indicator
            document.querySelector('.loading-indicator').classList.add('show');
            
            // Load events from JSON file
            fetch('events.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load events data');
                    }
                    return response.json();
                })
                .then(data => {
                    events = data.events;
                    initializeMap();
                    // Hide loading indicator
                    document.querySelector('.loading-indicator').classList.remove('show');
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                    document.querySelector('.event-list').innerHTML = 
                        '<div style="color: red; padding: 20px;">Error loading events. Please try refreshing the page.</div>';
                    // Hide loading indicator
                    document.querySelector('.loading-indicator').classList.remove('show');
                });
        });

        // Wrap the existing initialization code in a function
        function initializeMap() {
            const map = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            const sidebar = document.getElementById("sidebar");
            const calendar = document.querySelector(".calendar");

            // Store markers and event items
            const markers = [];
            const eventItems = [];
            let selectedEvents = [];
            let polyline = null;
            const timeInfo = document.getElementById('timeInfo');

            // Function to calculate days between dates
            function getDaysBetween(event1, event2) {
                // Get start dates of both events using our standardized YYYY-MM-DD format
                const date1 = new Date(event1.date.split('/')[0]);
                const date2 = new Date(event2.date.split('/')[0]);
                
                // Get end date of first event (if it's a range)
                const dates1 = event1.date.split('/');
                const endDate1 = dates1[1] ? new Date(dates1[1]) : date1;
                
                // Calculate days between end of first event and start of second event
                const diffTime = Math.abs(date2 - endDate1);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            // Function to calculate distance between two points in miles
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 3959; // Earth's radius in miles
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return Math.round(R * c);
            }

            // Function to get event duration in days
            function getEventDuration(event) {
                const dates = event.date.split('/');
                if (dates.length === 2) {
                    const startDate = new Date(dates[0]);
                    const endDate = new Date(dates[1]);
                    return Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                }
                return 1;
            }

            // Add this helper function for date formatting
            function formatDateForDisplay(dateStr) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const dates = dateStr.split('/');
                
                function formatSingleDate(date) {
                    const [year, month, day] = date.split('-');
                    return `${months[parseInt(month) - 1]} ${parseInt(day)}`;
                }
                
                if (dates.length === 2) {
                    return `${formatSingleDate(dates[0])} - ${formatSingleDate(dates[1])}`;
                }
                return formatSingleDate(dates[0]);
            }

            // Function to update the polyline and time info
            function updateSelection() {
                // Remove existing polyline and decorators
                if (polyline) {
                    map.removeLayer(polyline);
                }
                // Remove any existing decorators
                if (window.decorators) {
                    window.decorators.forEach(decorator => map.removeLayer(decorator));
                }
                window.decorators = [];

                // Clear time info
                timeInfo.innerHTML = '';

                if (selectedEvents.length >= 2) {
                    // Sort events by date
                    selectedEvents.sort((a, b) => {
                        const parseDate = (event) => {
                            const date = event.date.toLowerCase();
                            const year = date.includes('2026') ? 2026 : 2025;
                            const monthMap = {
                                'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                                'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11
                            };
                            
                            const monthMatch = date.match(/(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i);
                            if (monthMatch) {
                                return new Date(year, monthMap[monthMatch[1].toLowerCase()], 1);
                            }
                            return new Date(year, 11, 31);
                        };
                        return parseDate(a) - parseDate(b);
                    });

                    // Create points array for polyline
                    const points = selectedEvents.map(event => [event.lat, event.lng]);
                    polyline = L.polyline(points, {color: '#4CAF50', weight: 3}).addTo(map);
                    
                    // Add arrow decorators
                    const decorator = L.polylineDecorator(polyline, {
                        patterns: [
                            {
                                offset: 25,
                                repeat: 50,
                                symbol: L.Symbol.arrowHead({
                                    pixelSize: 15,
                                    polygon: false,
                                    pathOptions: {
                                        color: '#4CAF50',
                                        weight: 3
                                    }
                                })
                            }
                        ]
                    }).addTo(map);
                    
                    window.decorators = [decorator];
                    
                    map.fitBounds(polyline.getBounds());

                    // Start with header including collapse button
                    let timeHtml = `
                        <div class="timeline-header">
                            <h3 style="margin: 0;">Event Timeline:</h3>
                            <button class="collapse-btn" onclick="toggleTimeline()">Collapse</button>
                        </div>
                        <div class="timeline-content">`;

                    // Calculate and display detailed timeline
                    let currentMonth = '';
                    let totalDistance = 0;
                    let totalDays = 0;

                    for (let i = 0; i < selectedEvents.length; i++) {
                        const event = selectedEvents[i];
                        const eventDate = new Date(event.date.split('/')[0]);
                        const monthIndex = eventDate.getMonth();
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                      'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthName = months[monthIndex];
                        
                        // Add month header if it's a new month
                        if (monthName !== currentMonth) {
                            timeHtml += `<div class="month-header">${monthName} 2025</div>`;
                            currentMonth = monthName;
                        }

                        // Calculate event duration
                        const duration = getEventDuration(event);
                        totalDays += duration;

                        // Add event details
                        timeHtml += `
                            <div class="event-details">
                                <div class="event-name">${event.name}</div>
                                <div class="event-info">
                                    <div>📅 ${formatDateForDisplay(event.date)}</div>
                                    <div>📍 ${event.location}</div>
                                    <div>⏱️ ${duration} days</div>
                                </div>`;

                        // Add travel info if not the last event
                        if (i < selectedEvents.length - 1) {
                            const nextEvent = selectedEvents[i + 1];
                            const distance = calculateDistance(event.lat, event.lng, nextEvent.lat, nextEvent.lng);
                            totalDistance += distance;
                            const daysBetween = Math.round(getDaysBetween(event, nextEvent));
                            
                            timeHtml += `
                                <div class="travel-info">
                                    <div>🚗 ${distance} miles to ${nextEvent.name}</div>
                                    <div>⏱️ ${daysBetween} days until next event</div>
                                </div>`;
                        }

                        timeHtml += '</div>';
                    }

                    // Add summary
                    timeHtml += `
                        <div class="trip-summary">
                            <h4>Trip Summary</h4>
                            <div>Total Events: ${selectedEvents.length}</div>
                            <div>Total Distance: ${totalDistance} miles</div>
                            <div>Total Event Days: ${totalDays} days</div>
                            <div>Average Distance Between Events: ${Math.round(totalDistance / (selectedEvents.length - 1))} miles</div>
                        </div>`;

                    // Close the timeline-content div
                    timeHtml += '</div>';

                    timeInfo.innerHTML = timeHtml;
                }
            }

            // Function to select/deselect an event across all views
            function selectEvent(event, selected) {
                // Update calendar selections
                const eventDivs = document.querySelectorAll(`.calendar-event[data-event="${event.name}"]`);
                eventDivs.forEach(div => {
                    div.classList.toggle('selected', selected);
                });

                // Update sidebar selection
                const sidebarItem = eventItems.find(item => item.dataset.event === event.name);
                if (sidebarItem) {
                    sidebarItem.classList.toggle('selected', selected);
                }

                // Update selected events array
                const index = selectedEvents.indexOf(event);
                if (selected && index === -1) {
                    selectedEvents.push(event);
                    // Sort selected events by date whenever a new one is added
                    selectedEvents.sort((a, b) => {
                        const aDate = new Date(a.date.split('/')[0]);
                        const bDate = new Date(b.date.split('/')[0]);
                        return aDate - bDate;
                    });
                } else if (!selected && index !== -1) {
                    selectedEvents.splice(index, 1);
                }

                // Update visibility if showing selected only
                if (showingSelected) {
                    const sidebarItem = eventItems.find(item => item.dataset.event === event.name);
                    if (sidebarItem) {
                        sidebarItem.classList.toggle('show', selected);
                    }
                }

                updateSelection();
            }

            // Create and populate calendar
            function createCalendar() {
                const header = document.querySelector('.calendar-header');
                const calendar = document.querySelector('.calendar');
                
                // Clear existing content
                header.innerHTML = '';
                calendar.innerHTML = '';
                
                // Create header
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                days.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day-header';
                    dayHeader.textContent = day;
                    header.appendChild(dayHeader);
                });

                let currentMonth = -1;
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];

                // Start with January 1st, 2025
                const currentDate = new Date(2025, 0, 1);
                const endDate = new Date(2025, 11, 31);

                while (currentDate <= endDate) {
                    const month = currentDate.getMonth();

                    // If we're starting a new month
                    if (month !== currentMonth) {
                        currentMonth = month;
                        
                        // Add month divider
                        const monthDiv = document.createElement('div');
                        monthDiv.className = 'month-divider';
                        monthDiv.textContent = months[month] + ' 2025';
                        calendar.appendChild(monthDiv);

                        // Add empty cells for days before the 1st of the month
                        const firstDayOfMonth = new Date(2025, month, 1).getDay();
                        for (let i = 0; i < firstDayOfMonth; i++) {
                            const emptyDay = document.createElement('div');
                            emptyDay.className = 'calendar-day empty';
                            calendar.appendChild(emptyDay);
                        }
                    }

                    // Create the day cell
                    const day = document.createElement('div');
                    day.className = 'calendar-day';
                    
                    // Check if this is today
                    const today = new Date();
                    if (currentDate.getFullYear() === today.getFullYear() &&
                        currentDate.getMonth() === today.getMonth() &&
                        currentDate.getDate() === today.getDate()) {
                        day.classList.add('today');
                    }
                    
                    day.dataset.date = currentDate.toISOString().split('T')[0];
                    day.textContent = currentDate.getDate();
                    calendar.appendChild(day);

                    // If it's the last day of the month, add empty cells to complete the week
                    const isLastDayOfMonth = currentDate.getDate() === new Date(2025, month + 1, 0).getDate();
                    if (isLastDayOfMonth) {
                        const lastDayOfWeek = currentDate.getDay();
                        const remainingDays = 6 - lastDayOfWeek;
                        for (let i = 0; i < remainingDays; i++) {
                            const emptyDay = document.createElement('div');
                            emptyDay.className = 'calendar-day empty';
                            calendar.appendChild(emptyDay);
                        }
                    }

                    // Move to next day
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            // Populate calendar with events
            function populateCalendar() {
                const days = document.querySelectorAll('.calendar-day:not(.empty)');
                
                events.forEach(event => {
                    // Parse the standardized date format YYYY-MM-DD or YYYY-MM-DD/YYYY-MM-DD
                    const dates = event.date.split('/');
                    const startDate = new Date(dates[0]);
                    const endDate = dates[1] ? new Date(dates[1]) : startDate;
                    
                    // Calculate day of year for start date (1-based)
                    const startOfYear = new Date('2025-01-01');
                    const dayOfYear = Math.floor((startDate - startOfYear) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calculate duration (inclusive of both start and end dates)
                    const duration = dates[1] ? 
                        Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1 : 1;

                    for (let i = 0; i < duration; i++) {
                        const dayIndex = dayOfYear + i - 1; // Subtract 1 here since calendar array is 0-based
                        if (dayIndex >= 0 && dayIndex < days.length) {
                            const day = days[dayIndex];
                            const eventDiv = document.createElement('div');
                            eventDiv.className = 'calendar-event';
                            eventDiv.textContent = event.name;
                            eventDiv.dataset.event = event.name;
                            eventDiv.addEventListener('click', () => {
                                const selected = !eventDiv.classList.contains('selected');
                                selectEvent(event, selected);
                            });
                            day.appendChild(eventDiv);
                        }
                    }
                });
            }

            // Helper function to calculate days in previous months
            function getDaysInPreviousMonths(month, year) {
                let days = 0;
                for (let i = 0; i < month; i++) {
                    days += new Date(year, i + 1, 0).getDate();
                }
                return days;
            }

            // Initialize calendar
            createCalendar();
            populateCalendar();

            // Initialize sidebar with sorted events
            const sortedEvents = [...events].sort((a, b) => {
                const aDate = new Date(a.date.split('/')[0]);
                const bDate = new Date(b.date.split('/')[0]);
                return aDate - bDate;
            });

            // Create a bounds object to fit all markers
            const bounds = L.latLngBounds();

            // Function to check if event is in the past
            function isEventPast(event) {
                const now = new Date();
                const dates = event.date.split('/');
                const startDate = new Date(dates[0]);
                return startDate < now;
            }

            let showingSelected = false;

            window.toggleEventFilter = function(btn) {
                showingSelected = !showingSelected;
                btn.textContent = showingSelected ? "Show All" : "Show Selected";
                
                const eventItems = document.querySelectorAll('.event-item');
                eventItems.forEach(item => {
                    if (showingSelected) {
                        // Only show selected items
                        item.classList.toggle('show', item.classList.contains('selected'));
                    } else {
                        // Show all items
                        item.classList.add('show');
                    }
                });

                // Handle map markers visibility
                markers.forEach((marker, index) => {
                    if (showingSelected) {
                        // Only show markers for selected events
                        const isSelected = selectedEvents.some(event => 
                            event.lat === marker.getLatLng().lat && 
                            event.lng === marker.getLatLng().lng
                        );
                        if (isSelected) {
                            marker.addTo(map);
                        } else {
                            map.removeLayer(marker);
                        }
                    } else {
                        // Show all markers
                        marker.addTo(map);
                    }
                });

                // Update map bounds if showing selected
                if (showingSelected && selectedEvents.length > 0) {
                    const selectedBounds = L.latLngBounds(selectedEvents.map(event => [event.lat, event.lng]));
                    map.fitBounds(selectedBounds);
                } else {
                    // Reset to default view
                    map.fitBounds(usBounds, { maxZoom: 4 });
                }
            };

            sortedEvents.forEach(event => {
                const div = document.createElement("div");
                div.className = "event-item show";
                if (isEventPast(event)) {
                    div.classList.add('past');
                }
                if (event.status === 'suspect_date' || event.status === 'suspect_date_broken') {
                    div.classList.add('suspect-date');
                }
                div.dataset.event = event.name;
                
                // Create container for event info
                const eventInfo = document.createElement("div");
                eventInfo.className = "event-info";
                
                // Create event name element with appropriate link styling
                const eventName = document.createElement("div");
                eventName.className = "event-name";
                const link = document.createElement("a");
                link.href = event.ticketUrl;
                link.target = "_blank";
                link.textContent = event.name;
                
                if (event.status === 'suspect_date_broken') {
                    link.classList.add('broken-link');
                } else if (event.status === 'suspect_date') {
                    link.classList.add('suspect-link');
                }
                
                eventName.appendChild(link);
                
                // Create event details element
                const eventDetails = document.createElement("div");
                eventDetails.className = "event-details";
                
                // Format the date for display
                const dateStr = formatDateForDisplay(event.date);
                
                eventDetails.textContent = `${event.location} • ${dateStr}`;
                
                // Create zoom button
                const zoomBtn = document.createElement("button");
                zoomBtn.className = "zoom-btn";
                zoomBtn.textContent = "🔍";
                zoomBtn.style.display = "none";
                
                let isZoomed = false;
                
                // Assemble the elements
                eventInfo.appendChild(eventName);
                eventInfo.appendChild(eventDetails);
                div.appendChild(eventInfo);
                div.appendChild(zoomBtn);
                
                document.querySelector('.event-list').appendChild(div);
                eventItems.push(div);
                
                const marker = L.marker([event.lat, event.lng]).addTo(map)
                    .bindPopup(`<b><a href="${event.ticketUrl}" target="_blank">${event.name}</a></b><br>${event.location}<br>${dateStr}`);
                markers.push(marker);
                
                // Extend bounds to include this marker
                bounds.extend([event.lat, event.lng]);
                
                // Show zoom button on selection
                div.addEventListener("click", () => {
                    const selected = !div.classList.contains('selected');
                    selectEvent(event, selected);
                    zoomBtn.style.display = selected ? "block" : "none";
                });
                
                // Handle zoom button click
                zoomBtn.addEventListener("click", (e) => {
                    e.stopPropagation(); // Prevent triggering the div's click event
                    if (isZoomed) {
                        // Zoom out to show all selected events
                        if (polyline) {
                            map.fitBounds(polyline.getBounds());
                        } else {
                            map.fitBounds(usBounds, { maxZoom: 4 });
                        }
                        zoomBtn.textContent = "🔍";
                    } else {
                        // Zoom in to this event
                        map.setView([event.lat, event.lng], 12);
                        zoomBtn.textContent = "🌎";
                    }
                    isZoomed = !isZoomed;
                });
            });

            // Set initial map view to show more of North America
            const usBounds = L.latLngBounds([
                [15, -140], // Southwest corner - includes more of Mexico and Pacific
                [60, -50]   // Northeast corner - includes more of Canada and Atlantic
            ]);
            map.fitBounds(usBounds, { maxZoom: 4 }); // Reduced maxZoom to show more area

            // Add view toggle functionality
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            const mapView = document.getElementById('map');
            const calendarView = document.querySelector('.calendar-container');

            toggleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    toggleBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (btn.dataset.view === 'map') {
                        mapView.style.display = 'block';
                        calendarView.style.display = 'none';
                        map.invalidateSize(); // Refresh map size
                    } else {
                        mapView.style.display = 'none';
                        calendarView.style.display = 'block';
                    }
                });
            });

            // Initialize views
            mapView.style.display = 'block';
            calendarView.style.display = 'none';

            // Add this function to handle timeline toggling
            window.toggleTimeline = function() {
                const content = document.querySelector('.timeline-content');
                const button = document.querySelector('.collapse-btn');
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    button.textContent = 'Collapse';
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    content.classList.add('collapsed');
                    button.textContent = 'Expand';
                    content.style.maxHeight = '0';
                }
            };
        }
    </script>
</body>
</html>
